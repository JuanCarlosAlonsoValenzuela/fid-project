# Naive Bayes
En este notebook se aplica el modelo probabilístico Naive Bayes
Ventajas e inconvenientes de Naive Bayes
Se ha consultado la documentación del paquete Caret de NB (https://rpubs.com/maulikpatel/224581), partiendo los conocimientos adquiridos con los notebooks estudiados durante el curso.

## Carga de datos
Comenzamos cargando las librerías necesarias.
El paquete klarR es...

```{r}
# install.packages("klaR")
# library("klaR")
# install.packages("naivebayes")
library(naivebayes)
# install.packages("caret")
# install.packages("e1071")
# library(e1071)
# install.packages("caTools")
# library(caTools)
# install.packages("klaR")
library("klaR")
# install.packages("caret")
library("caret")
# install.packages("e1071")
library(e1071)
```

Cargamos los datos de entrenamiento y de pruebas preprocesados (Ver notebook data_analysis.Rmd)
```{r}
train <- read.csv("dataset/train_preprocessed.data", sep=",", row.names=NULL, header=TRUE)
head(train)
dim(train)

test <- read.csv("dataset/test_preprocessed.data", sep=",", row.names=NULL, header=TRUE)
head(test)
dim(test)
```

```{r}
summary(train)
```

Los atributos que se usarán para el entrenamiento son:
age, workclass, fnlwgt, education, marital_status, occupation, relationship, race, 
sex, native_country, hours_per_week_categorical, has_capital_gain, has_capital_loss

TODO: CONVERTIR fnlwgt A CATEGÓRICO
Convertimos el atributo age a categórico (grupos de 10 años)

Tener en cuenta que: age es numérico (convertir a categórico?), education_num es redundante, 
capital_gain y capital_loss han sido convertidos a categóricos, hours_per_week es categórico

La variable a predecir es target (Posibles valores: <=50K, >50K).

```{r}
convert_age_to_categorical <- function(x) {
    age <- as.numeric(x['age'])
    decade <- floor(age/10)*10
    # Convert decade to string
    decade <- as.character(paste(decade, decade+10, sep="_"))
    return(decade)
}	
```	

```{r}	
decade_train <- apply(train, 1, convert_age_to_categorical)
train <- cbind(train, decade=decade_train)

decade_test <- apply(test, 1, convert_age_to_categorical)
test <- cbind(test, decade=decade_test)
head(train)
head(test)
```

```{r}
transform_data <- function(dataframe) {
    dataframe <- transform(dataframe, age=as.integer(age), workclass=as.factor(workclass),
        fnlwgt=as.numeric(fnlwgt), education=as.factor(education), education_num=as.integer(education_num),
        marital_status=as.factor(marital_status), occupation=as.factor(occupation), relationship=as.factor(relationship),
        race=as.factor(race), sex=as.factor(sex), capital_gain=as.numeric(capital_gain), capital_loss=as.numeric(capital_loss),
        hours_per_week=as.integer(hours_per_week), native_country=as.factor(native_country), target=as.factor(target),
        hours_per_week_categorical=as.factor(hours_per_week_categorical),has_capital_gain=as.factor(has_capital_gain),
        has_capital_loss=as.factor(has_capital_loss), decade=as.factor(decade)
    )

    return(dataframe)
}
```

```{r}
train <- transform_data(train)
summary(train)	
dim(train)

test <- transform_data(test)
summary(test)
dim(test)
```

```{r}
# Removed fnlwgt and age
selected_attributes <- c("decade", "workclass", "education", "marital_status", "occupation", "relationship", 
"race", "sex", "native_country", "hours_per_week_categorical", "has_capital_gain", "has_capital_loss", "target")
train <- train[selected_attributes]

head(train)	
```	

```{r}
test <- test[selected_attributes]
head(test)
# head(y_test)
```	


```{r}
summary(train)	
summary(test)
```


# Entrenamiento del modelo
```{r}	
# set.seed(123)
model_nb <- naiveBayes(target ~ ., data=train, laplace=1)
model_nb
```	

```{r}

nb_grid <- expand.grid(
    laplace_values = c(0, 0.5, 1, 10, 20),
    eps_values = c(0.01, 0.1, 0.3, 0.5, 1.0),
    usepoisson_values = c(FALSE, TRUE)
)

```

```{r}
model_nb	
```	

```{r}
y_pred_test <- predict(model_nb, newdata = test)	
```	

```{r}
cm_test <- table(test$target, y_pred_test)
cm_test
```

```{r}
help(confusionMatrix)
```
```{r}
y_pred_train <- predict(model_nb, newdata = train)	
# cm_train <- table(train$target, y_pred_train)
cm_train <- confusionMatrix(data=y_pred_train, reference=train$target, positive=">50K", mode = "prec_recall")
cm_train

train_precision <- precision(data=y_pred_train, reference=train$target, relevant=">50K")
train_precision
train_recall <- recall(data=y_pred_train, reference=train$target, relevant=">50K")
train_recall
train_f1 <- F_meas(data=y_pred_train, reference=train$target, relevant=">50K")
train_f1
```	

```{r}
cm_test <- confusionMatrix(data=y_pred_test, reference=test$target, positive=">50K", mode = "prec_recall")
cm_test
```	
```{r}

```

```{r}
help(F_meas)
```